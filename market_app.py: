import requests
import os
import yfinance as yf

def get_indian_market():
    try:
        # Fetching Nifty 50 and major Indian stocks
        nifty = yf.Ticker("^NSEI").history(period="1d")['Close'].iloc[-1]
        tcs = yf.Ticker("TCS.NS").history(period="1d")['Close'].iloc[-1]
        return f"ğŸ‡®ğŸ‡³ **INDIAN MARKET**\nğŸ”¹ Nifty 50: **{nifty:.2f}**\nğŸ”¹ TCS: **{tcs:.2f}**\n"
    except:
        return "ğŸ‡®ğŸ‡³ Indian Market: Data unavailable.\n"

def get_hub_news(query):
    api_key = os.getenv("NEWS_API_KEY")
    # Searches for 1 top headline for your specific topics
    url = f"https://newsapi.org/v2/everything?q={query}&pageSize=1&sortBy=relevance&apiKey={api_key}"
    try:
        data = requests.get(url).json()
        article = data['articles'][0]
        return f"ğŸ“Œ **{query.upper()}**: {article['title']}\nğŸ”— [Read More]({article['url']})\n"
    except:
        return ""

def send_full_report():
    token = os.getenv("TELEGRAM_TOKEN")
    chat_id = os.getenv("TELEGRAM_CHAT_ID")
    
    report = "ğŸ› **FINANCIAL INTELLIGENCE HUB** ğŸ›\n\n"
    report += get_indian_market() + "\n"
    
    # Fetching your specific interest categories
    categories = ["Geopolitics", "Commodities Gold", "FinTech", "AI", "Healthcare"]
    for cat in categories:
        report += get_hub_news(cat)
    
    report += "\nğŸ“Š **Advising/Insight:** Markets show volatility in derivatives; maintain long-term focus.\n"
    report += "\nâš ï¸ *Note: Educational insights only.*"

    url = f"https://api.telegram.org/bot{token}/sendMessage"
    payload = {"chat_id": chat_id, "text": report, "parse_mode": "Markdown", "disable_web_page_preview": True}
    requests.post(url, data=payload)

if __name__ == "__main__":
    send_full_report()
